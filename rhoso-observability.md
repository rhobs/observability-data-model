# Openstack Observability

Protocols and semantic conventions for metrics in Red Hat OpenStack Services on Openshift (OSP 18+). This document currently covers the metrics portion of observability.

## Ingestion protocols

All metrics in OpenStack are collected via HTTP scrape endpoints that present the metrics in the [Prometheus Exposition Format](https://github.com/prometheus/docs/blob/main/content/docs/instrumenting/exposition_formats.md)

## Data Model

Metrics in OpenStack conform to the [Prometheus Data Model](https://prometheus.io/docs/concepts/data_model/)

## Semantic Conventions

The semantics of metrics data in OpenStack are inherited from the underlying collector agents in use.

* For VMs, the agent is Ceilometer, and the semantics are partially described in the [Ceilometer Measurements documentation](https://docs.openstack.org/ceilometer/latest/admin/telemetry-measurements.html)
  * NOTE: Only a subset of "pollsters" are enabled.
  * [Ceilometer Compute Agent Polling config](https://github.com/openstack-k8s-operators/telemetry-operator/blob/main/templates/ceilometercompute/config/polling.yaml#L5)
  * [Ceilometer Central Agent Polling config](https://github.com/openstack-k8s-operators/telemetry-operator/blob/main/templates/ceilometercentral/config/polling.yaml.j2#L5)
* For compute node Hosts, the agent is node_exporter, and the semantics are partially described in the [Prometheus Metric and Label Naming documentation](https://prometheus.io/docs/practices/naming/). 
  * NOTE: Only a subset of [all "Collectors"](https://github.com/prometheus/node_exporter?tab=readme-ov-file#collectors) are enabled.
  * [Node Exporter Collector config](https://github.com/openstack-k8s-operators/edpm-ansible/blob/main/roles/edpm_telemetry/tasks/install.yml#L50)

A thorough inventory of all labels in use and their specific semantics is still a WIP.

## USE/RED and (future) OTEL Compatibility

The following table summarizes the core metrics for VMs and compute node Hosts. Not all collected metrics are represented, but it covers everything that goes into our stock dashboards and represents the current (Apr 2024) best-fit to the USE model.

<table cellspacing="0" cellpadding="0"><tbody><tr style="height: 20px"><td dir="ltr">Resource</td><td dir="ltr">USE/RED Type</td><td dir="ltr">T-O Metric Name(s)</td><td dir="ltr">Units</td><td dir="ltr">Equivalent OTel Metric Name(s)</td><td dir="ltr">Notes</td></tr><tr style="height: 20px"><td rowspan="2">Host CPU</td><td>Utilization</td><td dir="ltr">node_cpu_seconds_total<br>instance:node_cpu_utilisation:rate1m</td><td dir="ltr">s<br>ratio</td><td dir="ltr">system.cpu.time<br>system.cpu.utilization</td><td dir="ltr">* logical_number attribute is the cpu label<br>* state attribute is the mode label</td></tr><tr style="height: 20px"><td>Saturation</td><td dir="ltr">node_load15<br>node_load5<br>node_load1</td><td></td><td>system.linux.cpu.load_15m<br>system.linux.cpu.load_5m<br>system.linux.cpu.load_1m</td><td dir="ltr">* not sure what the best unit description is. It&#39;s like a ratio, but it can go over 1<br>* expected a cpu label, but I guess this is pre-aggregated?</td></tr><tr style="height: 20px"><td rowspan="2">Host Memory</td><td>Utilization</td><td dir="ltr">node_memory_&lt;type&gt;_bytes<br>instance:node_memory_utilisation:ratio<br>node_memory_MemTotal_bytes</td><td dir="ltr">bytes<br>ratio<br>bytes</td><td>system.memory.usage<br>system.memory.utilization<br>system.memory.limit</td><td dir="ltr">* state attribute is represented by the &lt;type&gt; in the metrics name<br></td></tr><tr style="height: 20px"><td dir="ltr">Saturation</td><td dir="ltr">node_vmstat_pgmajfault<br>(node_memory_SwapTotal_bytes -<br>node_memory_SwapFree_bytes)</td><td dir="ltr">count<br>bytes</td><td dir="ltr">??<br>(system.paging.usage)</td><td dir="ltr"><br>* we use pgmajfault as a measure of saturation (without representing the # of pages/bytes)<br>* node_vmstat_pgpgin/out and node_vmstat_pswpin/out also exist, but are total byte counters, not a gauge like system.paging.usage<br>* (node_memory_SwapFree_bytes - node_memory_SwapFree_bytes) is most similar to system.paging.usage, but these are &quot;Pagefile Utilisation&quot; metrics, rather than memory saturation metrics</td></tr><tr style="height: 20px"><td dir="ltr" rowspan="2">Host FS</td><td>Utilization</td><td dir="ltr">(node_filesystem_size_bytes - <br>node_filesystem_free_bytes)<br>(&lt;above&gt; / node_filesystem_size_bytes)</td><td dir="ltr">bytes<br>ratio</td><td dir="ltr">system.filesystem.usage<br>system.filesystem.utilization</td><td dir="ltr">* device and mountpoint attributes have identically-named labels<br>* type attribute is the fstype label<br>* state attribute is always &quot;free&quot; as shown in the metric name<br>* the &quot;reserved&quot; state may be represented as the difference between &quot;free&quot; and &quot;avail&quot;<br>* mode attribute is represented by a separate metric called node_filesystem_readonly</td></tr><tr style="height: 20px"><td dir="ltr">Errors</td><td dir="ltr">node_filesystem_device_error</td><td dir="ltr">count</td><td dir="ltr">None?</td><td dir="ltr"></td></tr><tr style="height: 20px"><td dir="ltr" rowspan="3">Host Disk</td><td dir="ltr">Utilisation</td><td dir="ltr">node_disk_read_bytes_total<br>node_disk_written_bytes_total<br>node_disk_reads_completed_total<br>node_disk_writes_completed_total</td><td dir="ltr">bytes<br>count</td><td dir="ltr">system.disk.io<br>system.disk.operations</td><td dir="ltr">* device attribute has identically-named label<br>* separate metrics instead of a direction attribute</td></tr><tr style="height: 20px"><td dir="ltr">Saturation</td><td dir="ltr">node_disk_io_time_weighted_seconds_total<br>node_disk_io_now</td><td dir="ltr">s<br>count</td><td dir="ltr"><div style="width:224px;left:-1px">(new) system.disk.pending_operations</div></td><td dir="ltr">* device attribute has identically-named label</td></tr><tr style="height: 20px"><td dir="ltr">Duration</td><td dir="ltr">node_disk_io_time_seconds_total<br>node_disk_read_time_seconds_total<br>node_disk_write_time_seconds_total</td><td dir="ltr">s</td><td dir="ltr">system.disk.io_time<br>system.disk.operation_time</td><td dir="ltr">* device attribute has identically-named label<br>* separate metrics instead of a direction attribute<br>* io_time != read_time + write_time, I think because it doesn&#39;t account for merged/parallel operations</td></tr><tr style="height: 20px"><td dir="ltr" rowspan="3">Host Net</td><td dir="ltr">Utilisation</td><td dir="ltr">node_network_receive_bytes_total<br>node_network_transmit_bytes_total<br>node_network_receive_packets_total<br>node_network_transmit_packets_total</td><td dir="ltr">bytes<br>count</td><td dir="ltr">system.network.io<br>system.network.packets</td><td dir="ltr">* device attribute has identically-named label<br>* separate metrics instead of a direction attribute</td></tr><tr style="height: 20px"><td dir="ltr">Saturation</td><td dir="ltr">node_network_receive_drop_total<br>node_network_transmit_drop_total</td><td dir="ltr">count</td><td dir="ltr">system.network.dropped</td><td dir="ltr">* device attribute has identically-named label<br>* separate metrics instead of a direction attribute</td></tr><tr style="height: 20px"><td>Errors</td><td dir="ltr">node_network_receive_errs_total<br>node_network_transmit_errs_total</td><td dir="ltr">count</td><td dir="ltr"><br>system.network.errors</td><td dir="ltr">* device attribute has identically-named label<br>* separate metrics instead of a direction attribute</td></tr><tr style="height: 20px"><td dir="ltr">VM CPU</td><td dir="ltr">Utilization</td><td dir="ltr">ceilometer_cpu<br>vm:ceilometer_cpu:ratio1m</td><td dir="ltr">ns<br>ratio</td><td dir="ltr">system.cpu.time<br>system.cpu.utilization</td><td dir="ltr">* ceilometer reports this in nanoseconds instead of seconds<br>* logical_number attribute missing; this is a sum of all VCPUs<br>* state attribute missing; this is a sum of all non-idle states<br></td></tr><tr style="height: 20px"><td dir="ltr">VM Memory</td><td dir="ltr">Utilization</td><td dir="ltr">vm:ceilometer_memory_usage:total</td><td dir="ltr">bytes</td><td dir="ltr">system.memory.usage</td><td dir="ltr">* state attribute missing; unclear how buffers/cache/shared are represented<br>* underlying metric is in MB, recording rule corrects to bytes</td></tr><tr style="height: 71px"><td dir="ltr" rowspan="3">VM Disk</td><td dir="ltr">Utilization (R/W)</td><td dir="ltr">ceilometer_disk_device_read_bytes<br>ceilometer_disk_device_write_bytes<br>ceilometer_disk_device_read_requests<br>ceilometer_disk_device_write_requests</td><td dir="ltr">bytes<br><br>count</td><td dir="ltr">system.disk.io<br>system.disk.operations<br></td><td dir="ltr">* separate metrics instead of a direction attribute<br>* device attribute is present as a substring of the resource attribute<br></td></tr><tr style="height: 71px"><td dir="ltr">Utilization (Space)</td><td dir="ltr">ceilometer_disk_device_usage<br>ceilometer_disk_device_capacity</td><td dir="ltr">bytes</td><td dir="ltr">system.filesystem.usage<br>system.filesystem.utilization</td><td dir="ltr">* we&#39;ll need to add a calculation for &quot;utilization&quot;<br>* device attribute is present as a substring of the resource attribute<br>* mode, mountpoint, state, and type attributes are all missing</td></tr><tr style="height: 20px"><td dir="ltr">Duration</td><td dir="ltr">ceilometer_disk_device_read_latency<br>ceilometer_disk_device_write_latency</td><td dir="ltr">ns</td><td dir="ltr">system.disk.io_time<br>system.disk.operation_time</td><td dir="ltr">* ceilometer reports this in nanoseconds instead of seconds<br>* separate metrics instead of a direction attribute<br>* device attribute is present as a substring of the resource attribute<br>* unclear if these are io_time (total wall clock time, no parallel accounting) or operation_time (total * operations time where paralel operations are all counted)</td></tr><tr style="height: 69px"><td dir="ltr" rowspan="3">VM Net</td><td dir="ltr">Utilisation</td><td dir="ltr">ceilometer_network_incoming_bytes<br>ceilometer_network_outgoing_bytes<br>ceilometer_network_incoming_packets<br>ceilometer_network_outgoing_packets</td><td dir="ltr">bytes</td><td dir="ltr">system.network.io<br>system.network.packets</td><td dir="ltr">* separate metrics instead of a direction attribute<br>* device attribute is present as a substring of the resource_name attribute<br></td></tr><tr style="height: 69px"><td dir="ltr">Saturation</td><td dir="ltr">ceilometer_network_incoming_packets_drop<br>ceilometer_network_outgoing_packets_drop</td><td dir="ltr">count</td><td dir="ltr">system.network.dropped</td><td dir="ltr">* separate metrics instead of a direction attribute<br>* device attribute is present as a substring of the resource_name attribute</td></tr><tr style="height: 69px"><td dir="ltr">Errors</td><td dir="ltr">ceilometer_network_incoming_packets_error<br>ceilometer_network_outgoing_packets_error</td><td dir="ltr">count</td><td dir="ltr"><br>system.network.errors</td><td dir="ltr">* separate metrics instead of a direction attribute<br>* device attribute is present as a substring of the resource_name attribute</td></tr></tbody></table>